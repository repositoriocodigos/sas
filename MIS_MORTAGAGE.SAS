%LET MDATE = '01MAR2013'D;

PROC SQL;
	CREATE TABLE WORK.TB1 AS
		SELECT

			A.ACCT_NUM AS CONTA,
			A.LOCATION_CODE AS LOCATE,
			A.CACS_FUNCTION_CODE||CACS_STATE_NUMBER AS STATE,
			A.ORIGINAL_TERM AS DPD,
			A.BALANCE_AMT FORMAT COMMAX9.2 AS SALDO_DEVEDOR,
			A.BOC_RESPONSIBLE_COLLECTOR AS COLLECTOR,
			A.TOTAL_DELINQ_AMT FORMAT COMMAX9.2 AS SALDO_EM_ATRASO,
			A.CACS_FUNCTION_CODE AS FUNCTION
		FROM NWBRRCON.DRI_076_R_CACS_EXT_PRI_DG3 AS A
			WHERE A.MIS_DATE = &MDATE
				AND A.ACCT_NUM LIKE "CL%"  
				AND A.BOC_RESPONSIBLE_COLLECTOR EQ "ACP1"
				AND A.TOTAL_DELINQ_AMT ~= 0
				AND A.LOCATION_CODE EQ "010801"
				AND A.CACS_FUNCTION_CODE||CACS_STATE_NUMBER IN ("F01","F02","F03","F04","F06","F07","F11","F12","F13","F70",
				"M01","M02","M03","M04","M06","M07","M11","M12","M13","M70","H01","H02","H03","H04","H06","H07","H11","H12","H13","H70");
RUN;

DATA WORK.TB1;
	SET WORK.TB1;

	IF FUNCTION = "F" THEN
		BUCKET ='B1';

	IF FUNCTION = "M" THEN
		BUCKET = 'B2';

	IF FUNCTION = "H" THEN
		BUCKET = 'B3';
RUN;

PROC SQL;
	CREATE TABLE WORK.TB2 AS 
		SELECT
			
			A.USER_ID AS FET,
			A.COLLECTION_ACTIVITY_CODE||PARTY_CONTACTED_CODE||PLACE_CALLED AS FINALIZAÇÃO,
			A.MIS_DATE AS ACIONAMENTO,
			A.PROMISE_DATE_1 AS DATA_PY,
			A.PROMISE_AMT_1 FORMAT COMMAX9.2 AS VALUE_PY,
			A.ACCT_NUM AS CONTA
		FROM NWBRRCON.DRI_076_R_CACS_CCH_DG3 AS A
			WHERE A.MIS_DATE GE'01MAR2013'D AND A.MIS_DATE LE '31MAR2013'D
				AND A.PROMISE_AMT_1 ~= 0
				AND A.ACCT_NUM LIKE  "CL%"
				AND A.LOCATION_CODE EQ "010801";
RUN;

PROC SQL;
	CREATE TABLE WORK.TB3 AS
		SELECT
			A.*,
			B.*
		FROM WORK.TB1  AS A INNER JOIN WORK.TB2 AS B
			ON A.CONTA EQ B.CONTA;
RUN;
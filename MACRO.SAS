%LET _CLIENTTASKLABEL='MACROS';
%LET _CLIENTPROJECTPATH='C:\USERS\VPASSIN2\DOCUMENTS\ESTUDOS DIVERSOS3.EGP';
%LET _CLIENTPROJECTNAME='ESTUDOS DIVERSOS3.EGP';
%LET _SASPROGRAMFILE=;

GOPTIONS ACCESSIBLE;
*CONSTRUINDO A BASE DE CACHE DE SUSPENSÃO;
%MACRO CACHE_SUSPE;
DATA SUSPE.CACHE_SUSPENSAO;
SET SUSPE.SUSPENSION_201408
	SUSPE.SUSPENSION_201409
	SUSPE.SUSPENSION_201410 
	SUSPE.SUSPENSION_201411 
	SUSPE.SUSPENSION_201412
	SUSPE.SUSPENSION_201501;

IF DATA_SUSPENSAO NE .;

RENAME CD_CUSTOMER_BOND_KIND =  ESPECIE
		NR_CUSTOMER_BOND = NU_BOND
		NR_CUSTOMER_ITEM = NU_BOND_ITEM
		DT_CUSTOMER_BOND_DUE_DATE = DATA_VENCIMENTO
		BOND_ORIGINAL_VALOR = VLR_BOND;

FORMAT DATA_SUSPENSAO DT_CUSTOMER_BOND_DUE_DATE DATA_ATIVACAO DDMMYY10.;

KEEP CLIENTE CONTRATO PLANO DATA_SUSPENSAO CD_CUSTOMER_BOND_KIND NR_CUSTOMER_BOND NR_CUSTOMER_ITEM DT_CUSTOMER_BOND_DUE_DATE
BOND_ORIGINAL_VALOR CUSTOMER_ACCOUNT CREDIT_SCORE CD_REASON REASON PERSON_TYPE DATA_ATIVACAO;
RUN; 

PROC SORT DATA=SUSPE.CACHE_SUSPENSAO; BY CLIENTE CONTRATO DATA_SUSPENSAO; RUN;
%MEND;

*CONSTRUINDO A BASE DE CACHE DE REATIVAÇÃO;
%MACRO CACHE_REATIV;
DATA SUSPE.CACHE_REATIVACAO ;
SET SUSPE.SUSPENSION_201408
	SUSPE.SUSPENSION_201409
	SUSPE.SUSPENSION_201410 
	SUSPE.SUSPENSION_201411 
	SUSPE.SUSPENSION_201412
	SUSPE.SUSPENSION_201501;

IF DATA_SUSPENSAO NE . THEN DELETE;

IF DATA_REATIVACAO_ANTERIOR NE . THEN DATA_REATIVACAO = DATA_BASE;
IF DATA_REATIVACAO_NO_MES NE . THEN DATA_REATIVACAO = DATA_BASE;

RENAME CD_CUSTOMER_BOND_KIND =  ESPECIE
		NR_CUSTOMER_BOND = NU_BOND
		NR_CUSTOMER_ITEM = NU_BOND_ITEM
		DT_CUSTOMER_BOND_DUE_DATE = DATA_VENCIMENTO
		BOND_ORIGINAL_VALOR = VLR_BOND;

FORMAT DATA_SUSPENSAO DT_CUSTOMER_BOND_DUE_DATE DATA_ATIVACAO DATA_REATIVACAO_ANTERIOR DATA_REATIVACAO_NO_MES 
	DATA_REATIVACAO DDMMYY10.;

KEEP CLIENTE CONTRATO DATA_REATIVACAO;
RUN; 

PROC SORT DATA=SUSPE.CACHE_REATIVACAO; BY CLIENTE CONTRATO DESCENDING DATA_REATIVACAO; RUN;
PROC SORT DATA=SUSPE.CACHE_REATIVACAO NODUPKEY ; BY CLIENTE CONTRATO; RUN;
%MEND;

%MACRO IMPORT_MISCOBRANCA(MES=);
DATA TBMISCOBRANCA201501;
INFILE "\\BRSAO1W7449208\PLANEJAMENTO\MONTHLY_REPORT_NEW\&MES.\BASE\&MES.CONSOL_MES.TXT" LRECL=1050 ENCODING="WLATIN1" DELIMITER=';' 
MISSOVER DSD FIRSTOBS=2;
LENGTH 
IDCLIENTE  8 IDCONTRACT  8 PLANO $ 30 DTACTIVATION  8 DTREF  8 DTSUSPENSION  8 DTREACTIVATIONPREVMONTH  8 DTREACTIVATIONACTUALMONTH  8
LOGIN $ 8 NUMERO_SUSPENSOES  8 CD_COMPANY_UNIT  8 CDBOND $ 2 IDBOND  8 IDBONDSEQ  8 DTBOND  8 DT_CUSTOMER_BOND_DUE_DATE  8 DIAPASTDUE  8
VLRBOND  8 TYPE_TECHNOLOGY $ 4 CUSTOMER_ACCOUNT $ 22 IDADE_CUSTOMER  8 CDBILLCYCLE  8 FG_PRE_PAGO $ 1 CNPJ_DISTINTOS  8 SEGMENTATION $ 11
ORGANIZATION_TYPE $ 11 MARKET_FAMILY $ 15 MONTH_TENURE_RANGE  8 PERSON_TYPE $ 1 CREDIT_SCORE $ 1 MOBILE $ 16 CDREASON 8 REASON $ 20
CREDIT_SCORE_ENTRADA $ 2 TENURE_CONTRACT 8 DTBONDPAYMENT 8 TECHNOLOGY_DATA_TYPE $ 4;
INPUT
IDCLIENTE: BEST12. IDCONTRACT: BEST12. PLANO: $CHAR30. DTACTIVATION: DDMMYY10. DTREF: DDMMYY10.
DTSUSPENSION: DDMMYY10. DTREACTIVATIONPREVMONTH: DDMMYY10. DTREACTIVATIONACTUALMONTH: DDMMYY10.
LOGIN: $CHAR8. NUMERO_SUSPENSOES: BEST12. CD_COMPANY_UNIT: BEST12. CDBOND: $CHAR2. IDBOND: BEST12.
IDBONDSEQ: BEST12. DTBOND: DDMMYY10. DT_CUSTOMER_BOND_DUE_DATE: DDMMYY10. DIAPASTDUE: BEST12.
VLRBOND: BEST12. TYPE_TECHNOLOGY: $CHAR4. CUSTOMER_ACCOUNT: $CHAR22. IDADE_CUSTOMER: BEST12.
CDBILLCYCLE: BEST12. FG_PRE_PAGO: $CHAR1. CNPJ_DISTINTOS: BEST12. SEGMENTATION: $CHAR11.
ORGANIZATION_TYPE: $CHAR11. MARKET_FAMILY: $CHAR15. MONTH_TENURE_RANGE: BEST12. PERSON_TYPE: $CHAR1.
CREDIT_SCORE: $CHAR1. MOBILE: $CHAR16. CDREASON: BEST12. REASON: $CHAR20. CREDIT_SCORE_ENTRADA: $CHAR2.
TENURE_CONTRACT: BEST12. DTBONDPAYMENT: DDMMYY10. TECHNOLOGY_DATA_TYPE: $CHAR4.;

/*DROP 
LOGIN NUMERO_SUSPENSOES CD_COMPANY_UNIT DT_CUSTOMER_BOND_DUE_DATE TYPE_TECHNOLOGY CUSTOMER_ACCOUNT IDADE_CUSTOMER FG_PRE_PAGO CNPJ_DISTINTOS 
SEGMENTATION ORGANIZATION_TYPE MARKET_FAMILY MONTH_TENURE_RANGE PERSON_TYPE CREDIT_SCORE MOBILE CREDIT_SCORE_ENTRADA TENURE_CONTRACT 
DTREACTIVATIONACTUALMONTH DTREACTIVATIONPREVMONTH DTBONDPAYMENT
CDBOND IDBOND IDBONDSEQ DTBOND VLRBOND DIAPASTDUE; */

FORMAT 
DTACTIVATION DTREF DTSUSPENSION DTREACTIVATIONPREVMONTH DTREACTIVATIONACTUALMONTH DTBOND DTBONDPAYMENT DTDEACT DDMMYY10.
IDCLIENTE Z14.;

IF TYPE_TECHNOLOGY = 'IDEN' THEN DO;
	IF CDREASON = 318 THEN DTDEACT = DTSUSPENSION + 60;
	END;
IF TYPE_TECHNOLOGY = '3G' THEN DO;
	IF CDREASON=318 THEN DTDEACT = DTSUSPENSION + 75;
	IF CDREASON=230 THEN DTDEACT = DTSUSPENSION + 45;
	END;
RUN;
%MEND;





GOPTIONS NOACCESSIBLE;
%LET _CLIENTTASKLABEL=;
%LET _CLIENTPROJECTPATH=;
%LET _CLIENTPROJECTNAME=;
%LET _SASPROGRAMFILE=;

